<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Document</title>
        <link
            rel="stylesheet"
            href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
            integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
            crossorigin="anonymous"
        />
        <script
            src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
            integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"
        ></script>
        <style>
            #text {
                max-width: 70%;
                word-wrap: break-word;
            }
            h2 {
                padding-top: 30px;
            }
        </style>
    </head>

    <body>
        <h2>TanglePay-SDK</h2>
        Hi, this is the demo site of integrating your DApp with IOTA using TanglePay wallet.
        <br />
        For more details, please refer to the spec
        <a href="https://github.com/TanglePay/TanglePay-SDK" target="_blank">here</a>.

        <h2>Wallet status</h2>
        <div id="status">Wallet not installed</div>

        <div>
            <h2>API examples</h2>

            <h4>iota_connect</h4>
            <button onclick="onConnect()" class="btn btn-primary">Connect</button>

            <h4>iota_sign</h4>
            <button onclick="onSign()" class="btn btn-primary">Sign</button>

            <h4>iota_accounts</h4>
            <button onclick="onGetAccounts()" class="btn btn-primary">Get accounts</button>

            <h4>iota_getBalance</h4>
            <button onclick="getBalances()" class="btn btn-primary">Get balances</button>

            <h4>iota_sendTransaction</h4>
            <button onclick="sendTransaction()" class="btn btn-primary">Send Transaction</button>

            <h4>iota_changeAccount</h4>
            <button onclick="changeAccount()" class="btn btn-primary">Change Account</button>

            <h4>iota_getPublicKey</h4>
            <button onclick="getPublicKey()" class="btn btn-primary">Get PublicKey</button>

            <h4>personal_sign</h4>
            <button onclick="onEthPersonalSign()" class="btn btn-primary">Personal Sign</button>

            <h4>eth_getBalance</h4>
            <button onclick="getEthBalances()" class="btn btn-primary">Get Eth balances</button>

            <h4>eth_sendTransaction</h4>
            <button onclick="onEthSendTransaction()" class="btn btn-primary">ETH Send Transaction</button>
        </div>

        <div>
            <div id="text"></div>
        </div>
    </body>
    <script src="./dist/index.js"></script>
    <script>
        const dom = document.getElementById('text')
        const status = document.getElementById('status')

        window.addEventListener('iota-ready', () => {
            const iota = window.iota
            status.innerText = `${iota?.isTanglePay ? 'TanglePay installed' : 'TanglePay not installed'}
            Version: ${iota.tanglePayVersion || '--'}
        `

            window.onSign = async (bool) => {
                try {
                    const res = await iota.request({
                        method: 'iota_sign',
                        params: {
                            content: 'test sign content'
                        }
                    })
                    dom.innerText += `
    Sign result: ${JSON.stringify(res)}                
    `
                } catch (error) {
                    dom.innerText += `
    Sign result: ${JSON.stringify(error)}                
    `
                }
            }

            window.onEthPersonalSign = async (bool) => {
                try {
                    const res = await iota.request({
                        method: 'personal_sign',
                        params: {
                            content: 'test personal sign content'
                        }
                    })
                    dom.innerText += `
    Sign result: ${JSON.stringify(res)}                
    `
                } catch (error) {
                    dom.innerText += `
    Sign result: ${JSON.stringify(error)}                
    `
                }
            }

            // expire time, default: 1 day (1000 * 3600 * 24 milliseconds).
            window.onConnect = async (bool) => {
                try {
                    const res = await iota.request({
                        method: 'iota_connect',
                        params: {
                            // expires: 3000000
                        }
                    })
                    dom.innerText += `
    Connect result: ${JSON.stringify(res)}                
    `
                    return res
                } catch (error) {
                    console.log(error, '----')
                    dom.innerText += `
    Connect result: ${JSON.stringify(error)}                
    `
                }
            }

            window.onGetAccounts = async () => {
                try {
                    const res = await iota.request({
                        method: 'iota_accounts'
                    })
                    window.addressList = res
                    dom.innerText += `
    GetAccounts result: ${JSON.stringify(res)}                
    `
                    return res
                } catch (error) {
                    dom.innerText += `
    GetAccounts result: ${JSON.stringify(error)}                
    `
                }
            }

            window.getBalances = async (addressList) => {
                try {
                    // iota balance
                    const res = await iota.request({
                        method: 'iota_getBalance',
                        params: {
                            assetsList: ['iota', 'smr'], // ['iota','soonaverse','smr','asmb']
                            // addressList:addressList,
                            addressList: [] // current addressList
                        }
                    })
                    // shimmer balance
                    // const res = await iota.request({
                    //     method: 'iota_getBalance',
                    //     params: {
                    //     assetsList: ['smr'], // ['smr']
                    //         // addressList:addressList,
                    //         addressList: [] // current addressList
                    //     }
                    // })

                    dom.innerText += `
    Get balance result: ${JSON.stringify(res)}                
    `
                    return res
                } catch (error) {
                    dom.innerText += `
    Get balance result: ${JSON.stringify(error)}                
    `
                    return error
                }
            }

            window.sendTransaction = async () => {
                try {
                    const res = await iota.request({
                        method: 'iota_sendTransaction',
                        params: {
                            to: 'iota1qzrhx0ey6w4a9x0xg3zxagq2ufrw45qv8nlv24tkpxeetk864a4rkewh7e5',
                            value: 1,
                            data: 'test'
                        }
                    })

                    dom.innerText += `
    Send Transaction result: ${JSON.stringify(res)}                
    `
                    return res
                } catch (error) {
                    dom.innerText += `
    Send Transaction result: ${JSON.stringify(error)}                
    `
                    return error
                }
            }

            window.onEthSendTransaction = async () => {
                try {
                    // bsc
                    // const res = await iota.request({
                    //     method: 'eth_sendTransaction',
                    //     params: {
                    //         to: '0x55d398326f99059ff775485246999027b3197955',
                    //         value: 1000000000000000
                    //     }
                    // })

                    // usdt
                    const res = await iota.request({
                        method: 'eth_sendTransaction',
                        params: {
                            to: '0x55d398326f99059ff775485246999027b3197955',
                            value: 1000000000000000,
                            data: '0xa9059cbb0000000000000000000000003d6448479f92b0a3506e425f77c6482bc75f1092000000000000000000000000000000000000000000000000016345785d8a0000'
                        }
                    })

                    dom.innerText += `
    Send Transaction result: ${JSON.stringify(res)}                
    `
                    return res
                } catch (error) {
                    dom.innerText += `
    Send Transaction result: ${JSON.stringify(error)}                
    `
                    return error
                }
            }

            window.changeAccount = async () => {
                try {
                    const res = await iota.request({
                        method: 'iota_changeAccount',
                        params: {
                            network: 'bsc' //mainnet ,iota-evm
                        }
                    })

                    dom.innerText += `
    Change Account result: ${JSON.stringify(res)}                
    `
                    return res
                } catch (error) {
                    dom.innerText += `
    Change Account result: ${JSON.stringify(error)}                
    `
                    return error
                }
            }

            window.getEthBalances = async (addressList) => {
                try {
                    const res = await iota.request({
                        method: 'eth_getBalance',
                        params: {
                            assetsList: ['evm', 'soonaverse'], // ['evm','soonaverse']
                            // addressList:addressList,
                            addressList: [] // current addressList
                        }
                    })

                    dom.innerText += `
    Get eth balance result: ${JSON.stringify(res)}                
    `
                    return res
                } catch (error) {
                    dom.innerText += `
    Get eth balance result: ${JSON.stringify(error)}                
    `
                    return error
                }
            }

            window.getPublicKey = async () => {
                try {
                    const res = await iota.request({
                        method: 'iota_getPublicKey',
                        params: {} // current address
                        // params: { address: 'rms1qzthtcqc8e204naua69cly4csc98cweycw77044s6n3jgvf75kluz5ms6wn' }
                    })
                    dom.innerText += `
    Get publicKey result: ${JSON.stringify(res)}                
    `
                    return res
                } catch (error) {
                    dom.innerText += `
    Get publicKey result: ${JSON.stringify(error)}                
    `
                    return error
                }
            }

            const changeAccountHandler = (e) => {
                const { address } = e
                dom.innerText += `
    Switch account event: ${JSON.stringify(e)}                
    `
                // window.onConnect()
            }
            iota.on('accountsChanged', changeAccountHandler)
            // setTimeout(() => {
            //     iota.removeListener('accountsChanged', changeAccountHandler)
            //     iota.removeAllListener('accountsChanged')
            // }, 1000)

            window.onConnect()
        })
    </script>
</html>
